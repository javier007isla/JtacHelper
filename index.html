<!DOCTYPE html>
<html lang="es">
<head>
<!-- Discord / Open Graph Embed -->
<meta property="og:type" content="website">
<meta property="og:title" content="Javiito's JTAC Helper">
<meta property="og:description" content="Herramienta JTAC para Check-In, Gameplan y CAS 3/6/9-Line.">
<meta property="og:url" content="http://javiito.cl/jtac">
<meta property="og:image" content="http://javiito.cl/jtac/img/IMG1.png">

<!-- Color de la barra lateral del embed -->
<meta name="theme-color" content="#2e7d32">

<meta charset="UTF-8">
<title>JTAC Tactical Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
--bg:#0b0f0c;--panel:#121815;--accent:#5f7f5f;
--danger:#b04444;--text:#d8e0d8;
--jtac:#6fa86f;--air:#6fa0c8;
--left-panel-w:300px;
--header-h:64px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Consolas,monospace;background:var(--bg);color:var(--text);line-height:1.4;padding-top:var(--header-h)}
header{position:fixed;top:0;left:0;right:0;height:var(--header-h);display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:2px solid var(--accent);background:linear-gradient(180deg,#0d130f,#0b0f0c);z-index:1000}
header h1{margin:0;font-size:1.25rem;font-weight:600}
.container{max-width:1100px;margin:auto;padding:12px}
.section{background:var(--panel);border:1px solid #1e2a22;border-radius:6px;margin-bottom:12px;overflow:hidden}
.section summary{cursor:pointer;padding:10px 12px;font-weight:bold;color:var(--accent);background:#0e1411}
.section-content{padding:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
input,select,textarea{width:100%;background:#0c110d;border:1px solid #2a3a30;color:var(--text);padding:7px 8px;border-radius:4px;font-family:inherit;font-size:.85rem}
.mun-qty{
  width:64px;
  max-width:64px;
  margin-left:auto;
  padding:4px 6px;
  font-size:.75rem;
}
input:disabled,select:disabled,textarea:disabled{
  background:#0a0d0b;
  color:#7f8c7f;
  border-color:#1b251f;
  cursor:not-allowed;
  opacity:0.75;
}
label:has(input:disabled){
  opacity:0.7;
  cursor:not-allowed;
}
input[type="number"]{-moz-appearance:textfield}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
button{background:var(--accent);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:4px;font-weight:600;cursor:pointer;color:var(--text)}
.output{background:#070a08;border:1px dashed #2a3a30;padding:10px;white-space:pre-wrap;font-size:.8rem;margin-top:8px;border-radius:4px;overflow:clip}
.hidden{display:none !important}
.jtac{color:var(--jtac);font-weight:bold}
.air{color:var(--air);font-weight:bold}
.danger{color:var(--danger);font-weight:bold}
.small{font-size:.75rem;color:#9fb59f}
.grid label{display:flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid #2a3a30;border-radius:4px;background:#0c110d;cursor:pointer}
.grid label:hover{background:#111813}
.grid label input[type="checkbox"]{margin:0;width:14px;height:14px;cursor:pointer}
.mun-label{display:flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid #2a3a30;border-radius:4px;background:#0c110d;cursor:pointer}
.mun-label:hover{background:#111813}
.mun-label input[type="checkbox"]{margin:0;width:14px;height:14px;cursor:pointer}
.danger-inline,.vector-fields{display:flex;gap:8px;align-items:center;margin-left:auto}
.danger-inline{flex-wrap:nowrap}
.vector-fields{flex-wrap:nowrap}
.danger-inline .danger-fields{width:140px;max-width:140px}
.vector-fields input{width:140px;max-width:140px}
.section[data-section="remarks"] .danger-row{height:100%}
.vector-inline{flex-wrap:wrap}
.row-box{display:flex;align-items:center;gap:8px;padding:7px 10px;border:1px solid #2a3a30;border-radius:4px;background:#0c110d;cursor:pointer;white-space:nowrap}
.row-box input[type="checkbox"]{margin:0;width:14px;height:14px;flex:0 0 auto}
.mode-toggle{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.toggle-input{display:none}
.toggle-label{display:inline-flex;position:relative;width:220px;border-radius:999px;background:#122216;padding:6px;cursor:pointer;align-items:center}
.toggle-label .left,.toggle-label .right{flex:1;text-align:center;color:#9fb59f;font-size:.9rem}
.toggle-label .knob{position:absolute;top:50%;left:6px;width:100px;height:28px;background:#0b0f0c;border-radius:20px;transition:left .18s,transform .18s;transform:translateY(-50%)}
.toggle-input:checked + .toggle-label .knob{left:calc(100% - 6px - 100px)}
#clear-btn{padding:6px 10px;position:relative;overflow:hidden}
#clear-btn.holding{border-color:#a15b3b;box-shadow:0 0 0 2px rgba(161,91,59,0.3) inset}
#clear-btn.holding::after{
  content:"";
  position:absolute;
  left:0; top:0; bottom:0;
  width:0%;
  background:linear-gradient(90deg, rgba(161,91,59,0.15), rgba(161,91,59,0.45));
  animation:clearHoldFill 1s linear forwards;
  pointer-events:none;
}
@keyframes clearHoldFill{
  from{width:0%;}
  to{width:100%;}
}
.small-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:4px 8px;border-radius:4px;font-size:.8rem;cursor:pointer;margin-left:auto}
.menu-btn{background:transparent;border:1px solid rgba(255,255,255,0.12);color:var(--text);padding:6px 10px;border-radius:6px;cursor:pointer}
.back-btn{display:inline-flex;padding:4px 8px;min-width:0;width:auto}
.submenu-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.left-panel{position:fixed;top:var(--header-h);left:0;width:var(--left-panel-w);max-width:80vw;height:calc(100vh - var(--header-h));background:#0b0f0c;border-right:1px solid #1e2a22;transform:translateX(-100%);transition:transform .2s ease;z-index:999;padding:12px;box-sizing:border-box;overflow:auto;display:flex;flex-direction:column}
.left-panel.open{transform:translateX(0)}
.left-panel h4{margin:0 0 8px 0;color:var(--accent)}
.menu-buttons{display:flex;flex-direction:column;gap:8px;flex:1}
.menu-buttons .menu-btn-box.credits-btn{margin-top:auto}
.menu-btn-box{display:flex;align-items:center;justify-content:center;padding:10px 12px;border:1px solid #2a3a30;border-radius:4px;background:#0c110d;color:var(--text);cursor:pointer;font-weight:600;text-align:center}
.submenu-panel{position:fixed;top:var(--header-h);left:0;width:var(--left-panel-w);max-width:80vw;height:calc(100vh - var(--header-h));background:#0b0f0c;border-right:1px solid #1e2a22;transform:translateX(-100%);transition:transform .2s ease;z-index:1001;padding:12px;box-sizing:border-box;overflow:auto}
.submenu-panel#submenu-1{overflow:hidden;display:flex;flex-direction:column}
.submenu-panel.open{transform:translateX(0)}
.submenu-panel.credits-panel{display:flex;flex-direction:column}
.submenu-panel .small.credits-footer{margin-top:auto;color:#242c24 !important}
.dict-item{padding:6px 0;white-space:normal;overflow-wrap:anywhere}
.dict-item + .dict-item{border-top:1px solid #2f3f35}
.dict-wrap{position:relative;flex:1;min-height:0}
.dict-list{display:flex;flex-direction:column;gap:4px;padding-bottom:36px;max-height:calc(100% - 36px);overflow:hidden}
.submenu-panel .dict-nav{position:absolute;left:0;right:0;bottom:0;display:flex;gap:8px;justify-content:space-between}
.submenu-panel .dict-btn{background:#0c110d;border:1px solid #2a3a30;color:var(--text);padding:6px 10px;border-radius:4px;cursor:pointer}
.left-panel,.submenu-panel{max-height:calc(100vh - var(--header-h))}
@supports (height: 100dvh){
  .left-panel,.submenu-panel{height:calc(100dvh - var(--header-h));max-height:calc(100dvh - var(--header-h))}
}
.menu-backdrop{position:fixed;top:var(--header-h);left:0;right:0;bottom:0;background:rgba(0,0,0,0.45);z-index:997;opacity:0;pointer-events:none;transition:opacity .2s ease}
.menu-backdrop.show{opacity:1;pointer-events:auto}
h3{margin:8px 0;font-size:1rem;color:#b2c3b2}
.section-title{padding:10px 12px;font-weight:bold;color:var(--accent);background:#0e1411;border-bottom:1px solid #1e2a22}
.section[data-section="remarks"] .section-content{padding-top:2px}
.section[data-section="cas"] .small{margin-bottom:6px}
.section[data-section="cas"] #liner-select{margin:6px 0}
.section[data-section="cas"] .remarks-toggle{margin-top:6px}
.section[data-section="cas"] #omit-l1-l3-row{margin:6px 0 8px}
.section[data-section="missions"] .small{margin-bottom:6px}
.section[data-section="missions"] #mission-list{margin-bottom:0}
.section[data-section="remarks"] .ally-danger-row{display:grid;grid-template-columns:1fr 2fr;gap:10px;margin-top:8px;align-items:stretch}
.section[data-section="remarks"] .ally-danger-row .ally-row{width:100%}
.section[data-section="remarks"] .ally-danger-row .danger-fields{width:140px;max-width:140px}
.section[data-section="remarks"] .ally-danger-row .danger-fields.hidden{display:none}
.section[data-section="remarks"] .vector-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:8px}
.section[data-section="remarks"] .vector-fields{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.section[data-section="remarks"] .vector-fields.hidden{display:none}
.section[data-section="remarks"] .vector-fields input{width:140px}
.section[data-section="remarks"] .vector-fields .pm{font-weight:700;justify-self:center}
.section[data-section="remarks"] .danger-row{width:100%}
.section[data-section="remarks"] .danger-row.danger{border-color:var(--danger)}
.section[data-section="remarks"] .danger-row.danger input[type="checkbox"]{accent-color:var(--danger)}
.section[data-section="remarks"] .preauth-row{margin-top:8px;gap:10px}
.section[data-section="remarks"] .preauth-row label{white-space:nowrap}
.section[data-section="remarks"] .killbox-row.ally-active{color:#3b5f8a;border-color:#3b5f8a}
.section[data-section="remarks"] .killbox-row.ally-active input[type="checkbox"]{accent-color:#3b5f8a}
.section[data-section="remarks"] .killbox-row.danger{border-color:var(--danger);color:var(--text)}
.section[data-section="remarks"] .killbox-row.danger input[type="checkbox"]{accent-color:var(--danger)}
.section[data-section="remarks"] .killbox-row.full{grid-column:1 / -1}
.section[data-section="remarks"] .preauth-row.compact{
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
}
.section[data-section="remarks"] .preauth-row.compact #preauth-label{
  grid-column:1 / 2;
  width:100%;
}
.section[data-section="remarks"] .killbox-input{width:100%}
.section[data-section="remarks"] .killbox-input.danger{border-color:var(--danger);color:var(--text)}
.section[data-section="remarks"] .killbox-input.danger::placeholder{color:#c57b7b}
.section[data-section="remarks"] .killbox-input.hidden{display:none}
.section[data-section="remarks"] .ally-row.ally-active{color:#3b5f8a;border-color:#3b5f8a}
.section[data-section="remarks"] .ally-row.ally-active input[type="checkbox"]{accent-color:#3b5f8a}
.ally-text{color:#3b5f8a;font-weight:600}
.popout-tab{position:fixed;top:40%;left:0;transform:translateX(0);background:var(--accent);color:var(--text);border:1px solid rgba(255,255,255,0.12);border-left:none;padding:10px 12px;border-radius:0 6px 6px 0;cursor:pointer;z-index:9999}
.popout-panel{position:fixed;top:0;left:0;width:33vw;max-width:420px;min-width:260px;height:100vh;background:#0b0f0c;border-right:1px solid #1e2a22;transform:translateX(-100%);transition:transform .2s ease;z-index:9998;padding:12px;box-sizing:border-box;overflow:auto}
.popout-panel.open{transform:translateX(0)}
.popout-panel h4{margin:0 0 8px 0;color:var(--accent)}
@media (max-width: 768px){
  :root{--left-panel-w:80vw;--header-h:76px}
  .section[data-section="remarks"] .ally-danger-row{grid-template-columns:1fr}
  .section[data-section="remarks"] .vector-row{align-items:flex-start;justify-content:flex-start}
  .section[data-section="remarks"] .danger-row,
  .section[data-section="remarks"] .vector-row{width:100%}
  .section[data-section="remarks"] .vector-row label{
    width:100%;
    display:flex !important;
    align-items:center;
    justify-content:flex-start !important;
    gap:8px;
    text-align:left !important;
    padding:7px 10px;
  }
  .section[data-section="remarks"] .danger-row span,
  .section[data-section="remarks"] .vector-row label span{flex:1 1 auto}
  .section[data-section="remarks"] .vector-row label input[type="checkbox"]{flex:0 0 auto}
  .section[data-section="remarks"] .vector-fields,
  .section[data-section="remarks"] .danger-fields{width:100%;min-width:0}
  .section[data-section="remarks"] .vector-fields input,
  .section[data-section="remarks"] .danger-fields input{width:100%;max-width:100%}
  .danger-row,.vector-inline{flex-wrap:wrap}
  .vector-inline{padding:6px 6px}
  .danger-inline{
    width:100%;
    margin-left:0;
    display:grid;
    grid-template-columns:1fr 1fr;
    column-gap:6px;
    align-items:center;
  }
  .section[data-section="remarks"] .danger-inline .danger-fields{
    width:100%;
    max-width:100%;
  }
  .vector-fields{
    width:100%;
    margin-left:0;
    display:flex;
    flex-wrap:nowrap;
    align-items:center;
    gap:0;
  }
  .section[data-section="remarks"] .vector-fields input{
    flex:1 1 0;
    min-width:0;
    width:100%;
    max-width:100%;
  }
  .vector-fields .pm{
    flex:0 0 auto;
    padding:0;
    text-align:center;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:20px;
    min-width:20px;
    max-width:20px;
    height:28px;
    background:#0c110d;
    border:1px solid #2a3a30;
    border-radius:4px;
    margin:0 2px;
    padding:0;
  }
}
.section[data-section="gen"] .mode-toggle{margin-top:8px}
.section[data-section="gen"] .output{margin-top:8px}
.section[data-section="hints"] ul{margin:0;padding-left:18px}
.section[data-section="hints"] li{margin:4px 0}
</style>
</head>
<body spellcheck="false">
<!-- Header fijo con men√∫ y bot√≥n de limpiar -->
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <button class="menu-btn" id="menu-btn">&#9776;</button>
<h1 data-i18n="app.title">JTAC Tactical Helper</h1>
  </div>
  <button id="clear-btn" data-i18n="action.clear_all">Limpiar todo</button>
</header>
<div class="container">
<!-- Callsigns -->
<details class="section" data-section="callsigns">
<summary data-i18n="section.callsigns">CALLSIGNS</summary>
<div class="section-content grid">
  <input id="cs-jtac" placeholder="JTAC / FAC Callsign" data-i18n-placeholder="callsign.placeholder">
  <input id="cs-ground" placeholder="Comandante Terrestre" data-i18n-placeholder="callsign.ground" data-i18n-title="hint.cs_ground">
</div>
</details>

<!-- Check-in de aeronaves -->
<details class="section" data-section="air">
<summary data-i18n="section.air">CHECK-IN AERONAVES</summary>
<div class="section-content">

<div class="small" data-i18n="air.available_note">Aeronaves disponibles | La aeronave seleccionada es la ACTIVA</div>
<div class="grid" id="air-list">
  <label><input type="checkbox" id="air-present-0"> <span data-i18n="air.present_1">Aeronave 1</span> <button class="small-btn" id="air-clear-0" data-i18n-title="hint.air_clear">üóëÔ∏è</button></label>
  <label><input type="checkbox" id="air-present-1"> <span data-i18n="air.present_2">Aeronave 2</span> <button class="small-btn" id="air-clear-1" data-i18n-title="hint.air_clear">üóëÔ∏è</button></label>
  <label><input type="checkbox" id="air-present-2"> <span data-i18n="air.present_3">Aeronave 3</span> <button class="small-btn" id="air-clear-2" data-i18n-title="hint.air_clear">üóëÔ∏è</button></label>
</div>
<br>
<div class="grid">
  <input id="air-l1" placeholder="L1 CALLSIGN" data-i18n-placeholder="air.l1">
  <input id="air-l2" placeholder="L2 AERONAVE" data-i18n-placeholder="air.l2">
  <input id="air-l3" placeholder="L3 POSICI√ìN" data-i18n-placeholder="air.l3">
  <input id="air-l4" placeholder="L4 ARMAMENTO" data-i18n-placeholder="air.l4">
  <input id="air-l5" type="number" inputmode="numeric" placeholder="L5 PLAYTIME" data-i18n-placeholder="air.l5">
  <input id="air-l6" placeholder="L6 C√ìDIGO DE ABORTO" data-i18n-placeholder="air.l6">
  <input id="air-l7" placeholder="L7 REMARKS" data-i18n-placeholder="air.l7">
</div>

</div>
</details>
<!-- Misiones -->
<div class="section" data-section="missions">
  <div class="section-title" data-i18n="section.missions">MISIONES</div>
  <div class="section-content">
    <div class="grid" id="mission-list">
      <label><input type="checkbox" id="mission-present-0"> <span data-i18n="mission.present_1">Misi√≥n 1</span> <button class="small-btn" id="mission-clear-0" data-i18n-title="hint.mission_clear">üóëÔ∏è</button></label>
      <label><input type="checkbox" id="mission-present-1"> <span data-i18n="mission.present_2">Misi√≥n 2</span> <button class="small-btn" id="mission-clear-1" data-i18n-title="hint.mission_clear">üóëÔ∏è</button></label>
      <label><input type="checkbox" id="mission-present-2"> <span data-i18n="mission.present_3">Misi√≥n 3</span> <button class="small-btn" id="mission-clear-2" data-i18n-title="hint.mission_clear">üóëÔ∏è</button></label>
    </div>
  </div>
</div>
<!-- Gameplan -->
<details class="section" data-section="gameplan">
<summary data-i18n="section.gameplan">GAMEPLAN</summary>
<div class="section-content">
<h3 data-i18n="gameplan.control_type">Tipo de Control</h3>
<div class="grid">
  <label><input type="checkbox" id="castype-1" name="castype" value="Tipo 1"> <span data-i18n="gameplan.cas_type_1">CAS Tipo 1</span></label>
  <label><input type="checkbox" id="castype-2" name="castype" value="Tipo 2"> <span data-i18n="gameplan.cas_type_2">CAS Tipo 2</span></label>
  <label><input type="checkbox" id="castype-3" name="castype" value="Tipo 3"> <span data-i18n="gameplan.cas_type_3">CAS Tipo 3</span></label>
</div>
<div id="attack-method-block">
<h3 data-i18n="gameplan.attack_method">M√©todo de Ataque</h3>
<div class="grid">
  <label><input type="checkbox" id="attackmethod-bot" name="attackmethod" value="BOT"> <span data-i18n="gameplan.bot">Bomb on Target</span></label>
  <label><input type="checkbox" id="attackmethod-boc" name="attackmethod" value="BOC"> <span data-i18n="gameplan.boc">Bomb on Coordinate</span></label>
</div></div>
<h3 data-i18n="gameplan.requested_munition">Munici√≥n Solicitada</h3>
<div id="req-munition-list" class="grid"></div>

</div>
</details>

<!-- CAS 3/6/9-Line -->
<details class="section" data-section="cas">
<summary data-i18n="section.cas">CAS (3 / 6 / 9 LINE)</summary>
<div class="section-content">
<select id="liner-select" onchange="updateLiner()">
<option value="3" data-i18n="cas.3line">3-Line</option>
<option value="6" data-i18n="cas.6line">6-Line</option>
<option value="9" selected data-i18n="cas.9line">9-Line</option>
</select>
<div class="grid" id="omit-l1-l3-row">
  <label><input type="checkbox" id="omit-l1-l3"> <span data-i18n="cas.omit_l1_l3">Omitir L1 a L3</span></label>
</div>
<div class="grid" id="liner-fields">
<input id="9L-L1" data-line="1" placeholder="L1 IP / BP">
<input id="9L-L2" data-line="2" placeholder="L2 Heading">
<input id="9L-L3" data-line="3" type="number" inputmode="numeric" placeholder="L3 Distancia">
<input id="9L-L4" data-line="4" placeholder="L4 Elevaci√≥n">
<input id="9L-L5" data-line="5" placeholder="L5 Descripci√≥n objetivo">
<input id="9L-L6" data-line="6" placeholder="L6 Coordenadas">
<input id="9L-L7" data-line="7" placeholder="L7 Tipo de marcaci√≥n">
<input id="9L-L8" data-line="8" placeholder="L8 Tropas amigas">
<input id="9L-L9" data-line="9" type="number" inputmode="numeric" placeholder="L9 Egreso">
</div>
<div class="grid remarks-toggle">
<label><input type="checkbox" id="include-remarks"> <span data-i18n="cas.remarks_toggle">Remarks</span></label>
</div>
</div>
</details>
<!-- Remarks -->
<details class="section" data-section="remarks">
<summary data-i18n="section.remarks">REMARKS</summary>
<div class="section-content">
  <div class="grid preauth-row" id="preauth-row">
    <label id="preauth-label" class="hidden"><input type="checkbox" id="preauth-toggle"> <span data-i18n="remarks.preauth">Preautorizado</span></label>
    <label class="killbox-row row-box hidden" id="killbox-label"><input type="checkbox" id="killbox-toggle"> <span data-i18n="remarks.killbox">Killbox</span></label>
    <input class="killbox-input hidden" id="killbox-input" placeholder="Killbox" data-i18n-placeholder="remarks.killbox">
  </div>
  <div class="ally-danger-row">
    <label class="ally-row row-box" id="allies-in-area-label"><input type="checkbox" id="allies-in-area-toggle"> <span data-i18n="remarks.allies_in_area">Aliados en area</span></label>
    <label class="danger-row row-box mun-label" id="danger-close-row">
      <input type="checkbox" id="danger-close-toggle"><span data-i18n="remarks.danger_close">Danger close</span>
      <span class="danger-inline">
        <input class="danger-fields hidden" id="danger-close-deg" type="number" inputmode="numeric" min="0" max="360" placeholder="Grados (0-360)" data-i18n-placeholder="remarks.deg">
        <input class="danger-fields hidden" id="danger-close-dist" type="number" inputmode="numeric" placeholder="Metros" data-i18n-placeholder="remarks.meters">
      </span>
    </label>
  </div>
  <div class="vector-row">
    <label class="row-box mun-label vector-inline">
      <input type="checkbox" id="vector-final-toggle"><span data-i18n="remarks.vector_final">Vector final</span>
      <span class="vector-fields hidden" id="vector-final-fields">
        <input id="vector-final-deg" type="number" inputmode="numeric" min="0" max="360" placeholder="Grados (0-360)" data-i18n-placeholder="remarks.deg">
        <span class="pm">&plusmn;</span>
        <input id="vector-final-var" type="number" inputmode="numeric" placeholder="Grados" data-i18n-placeholder="remarks.deg">
      </span>
    </label>
  </div>
  <textarea id="cas-remarks" placeholder="Remarks" rows="4" style="margin-top:8px" data-i18n-placeholder="remarks.remarks_placeholder"></textarea>
</div>
</details>

<!-- Generador de salida -->
<div class="section" data-section="gen">
  <div class="section-title" data-i18n="section.generator">GENERADOR</div>
  <div class="section-content">
    <div class="mode-toggle">
      <input type="checkbox" id="cas-mode-radio" class="toggle-input" checked>
      <label for="cas-mode-radio" class="toggle-label">
        <span class="left" data-i18n="gen.voice">Voz corrida</span>
        <span class="right" data-i18n="gen.text">Texto</span>
        <span class="knob"></span>
      </label>
      <button id="cas-gen" data-i18n="action.generate">Generar</button>
    </div>
    <div id="cas-output" class="output" tabindex="0"></div>
  </div>
</div>

<!-- Panel lateral y submen√∫s -->
<div class="left-panel" id="left-panel">
  <h4 data-i18n="menu.title">Men√∫</h4>
  <div class="menu-buttons">
    <button class="menu-btn-box" data-submenu="submenu-1" data-i18n="menu.terminology">Terminologia</button>
    <button class="menu-btn-box" data-submenu="submenu-2" data-i18n="menu.import_export">Importar / Exportar</button>
    <button class="menu-btn-box" data-submenu="submenu-3" data-i18n="menu.settings">Configuraciones</button>
    <button class="menu-btn-box credits-btn" data-submenu="submenu-4" data-i18n="menu.credits">Cr√©ditos</button>
  </div>
</div>
<div class="menu-backdrop" id="menu-backdrop"></div>
<div class="submenu-panel" id="submenu-1">
  <div class="submenu-header">
    <button class="menu-btn back-btn" data-back="submenu-1">‚óÄ</button>
    <h4 data-i18n="submenu.1.title">Terminolog√≠a</h4>
  </div>
  <div class="section-content dict-wrap">
    <div id="dict-list" class="dict-list"></div>
    <div class="dict-nav">
      <button class="dict-btn" id="dict-prev" aria-label="Prev">‚óÄ</button>
      <span id="dict-page-indicator" class="small"></span>
      <button class="dict-btn" id="dict-next" aria-label="Next">‚ñ∂</button>
    </div>
  </div>
</div>
<div class="submenu-panel" id="submenu-2">
  <div class="submenu-header">
    <button class="menu-btn back-btn" data-back="submenu-2">‚óÄ</button>
    <h4 data-i18n="submenu.import_export.title">Importar / Exportar</h4>
  </div>
  <p class="small" data-i18n="submenu.import_export.desc">Copia y pega el estado del proyecto para respaldo o traslado.</p>
  <div class="grid" style="margin-top:8px">
    <textarea id="import-export-text" rows="6" placeholder="Pega aqu√≠ el texto para importar o usa Exportar" data-i18n-placeholder="submenu.import_export.placeholder"></textarea>
  </div>
  <div class="grid" style="margin-top:8px">
    <button class="menu-btn-box" id="export-btn" data-i18n="action.export">Exportar</button>
    <button class="menu-btn-box" id="import-btn" data-i18n="action.import">Importar</button>
  </div>
</div>
<div class="submenu-panel" id="submenu-3">
  <div class="submenu-header">
    <button class="menu-btn back-btn" data-back="submenu-3">‚óÄ</button>
    <h4 data-i18n="submenu.settings.title">Configuraciones</h4>
  </div>
  <div class="grid" style="margin-top:8px">
    <label class="row-box" style="width:100%;justify-content:space-between">
      <span data-i18n="settings.language">Idioma</span>
      <select id="lang-select" style="width:auto;min-width:140px">
        <option value="es" data-i18n="settings.lang.es">Espa√±ol</option>
        <option value="en" data-i18n="settings.lang.en">English</option>
      </select>
    </label>
    <label class="row-box" style="width:100%;justify-content:space-between">
      <span data-i18n="settings.units">Unidades</span>
      <select id="unit-select" style="width:auto;min-width:140px">
        <option value="m" data-i18n="settings.units.m">Metros</option>
        <option value="ft" data-i18n="settings.units.ft">Pies</option>
      </select>
    </label>
  </div>
</div>
<div class="submenu-panel credits-panel" id="submenu-4">
  <div class="submenu-header">
    <button class="menu-btn back-btn" data-back="submenu-4">‚óÄ</button>
    <h4 data-i18n="credits.title">Cr√©ditos</h4>
  </div>
  <img src="img/credits.png" alt="Cr√©ditos" style="width:33%;max-width:220px;display:block;margin:8px auto;border-radius:6px;">
  <p style="text-align:center" data-i18n="credits.line1">Para Jtacs y futuros Jtacs.</p>
  <p style="text-align:center" data-i18n="credits.line2">Hecho con mucho amor y aun mucha mas IA por Javiito_CL.</p>
  <p class="small credits-footer" style="text-align:center" data-i18n="credits.line3">Exxo para de ponerme los cuernos hdp</p>
</div>


</div>
<script>
// ====== Referencias de UI ======
const csJtac = document.getElementById('cs-jtac');
const csGround = document.getElementById('cs-ground');
const airPresentEls = [
  document.getElementById('air-present-0'),
  document.getElementById('air-present-1'),
  document.getElementById('air-present-2')
];
const airL1 = document.getElementById('air-l1');
const airL2 = document.getElementById('air-l2');
const airL3 = document.getElementById('air-l3');
const airL4 = document.getElementById('air-l4');
const airL5 = document.getElementById('air-l5');
const airL6 = document.getElementById('air-l6');
const airL7 = document.getElementById('air-l7');
const linerSelect = document.getElementById('liner-select');
const linerFields = document.getElementById('liner-fields');
const omitL1L3El = document.getElementById('omit-l1-l3');
const omitL1L3RowEl = document.getElementById('omit-l1-l3-row');
const attackMethodBlockEl = document.getElementById('attack-method-block');
const casRemarksEl = document.getElementById('cas-remarks');
const includeRemarksEl = document.getElementById('include-remarks');
const casOutput = document.getElementById('cas-output');
const remarksSection = document.querySelector('details.section[data-section="remarks"]');
const vectorFinalToggleEl = document.getElementById('vector-final-toggle');
const vectorFinalFieldsEl = document.getElementById('vector-final-fields');
const vectorFinalDegEl = document.getElementById('vector-final-deg');
const vectorFinalVarEl = document.getElementById('vector-final-var');
const preauthToggleEl = document.getElementById('preauth-toggle');
const preauthRowEl = document.getElementById('preauth-row');
const preauthLabelEl = document.getElementById('preauth-label');
const alliesInAreaToggleEl = document.getElementById('allies-in-area-toggle');
const alliesInAreaLabelEl = document.getElementById('allies-in-area-label');
const killboxToggleEl = document.getElementById('killbox-toggle');
const killboxLabelEl = document.getElementById('killbox-label');
const killboxInputEl = document.getElementById('killbox-input');
const leftPanel = document.getElementById('left-panel');
const menuBtn = document.getElementById('menu-btn');
const menuBackdrop = document.getElementById('menu-backdrop');
const clearBtnEl = document.getElementById('clear-btn');
const dangerCloseToggleEl = document.getElementById('danger-close-toggle');
const dangerCloseDegEl = document.getElementById('danger-close-deg');
const dangerCloseDistEl = document.getElementById('danger-close-dist');
const dangerCloseRowEl = document.getElementById('danger-close-row');
const importExportTextEl = document.getElementById('import-export-text');
const exportBtnEl = document.getElementById('export-btn');
const importBtnEl = document.getElementById('import-btn');
const missionPresentEls = [
  document.getElementById('mission-present-0'),
  document.getElementById('mission-present-1'),
  document.getElementById('mission-present-2')
];
const casModeRadioEl = document.getElementById('cas-mode-radio');
const casGenBtn = document.getElementById('cas-gen');
const reqMunitionListEl = document.getElementById('req-munition-list');
const castypeEls = [...document.querySelectorAll('input[name="castype"]')];
const attackMethodEls = [...document.querySelectorAll('input[name="attackmethod"]')];
let pendingMunitionSelection = null;
const langSelectEl = document.getElementById('lang-select');
const unitSelectEl = document.getElementById('unit-select');
const dictListEl = document.getElementById('dict-list');
const dictPrevEl = document.getElementById('dict-prev');
const dictNextEl = document.getElementById('dict-next');
const dictPageIndicatorEl = document.getElementById('dict-page-indicator');

// ====== i18n ======
let translations = {};
let currentLang = 'es';
function t(key, vars){
  const raw = (translations && translations[key]) ? translations[key] : key;
  if(!vars) return raw;
  return Object.keys(vars).reduce((acc,k)=> acc.replaceAll(`{${k}}`, vars[k]), raw);
}

function getUnit(){
  return localStorage.getItem('jtac_unit') || 'm';
}

function setUnit(unit){
  const safe = (unit === 'ft') ? 'ft' : 'm';
  localStorage.setItem('jtac_unit', safe);
  applyUnitToUI();
}

// ====== Hints ======
const linerHints = {
  3: {
    1: "hint.3l.l1",
    2: "hint.3l.l2",
    3: "hint.3l.l3"
  },
  6: {
    1: "hint.6l.l1",
    2: "hint.6l.l2",
    3: "hint.6l.l3",
    4: "hint.6l.l4",
    5: "hint.6l.l5",
    6: "hint.6l.l6"
  },
  9: {
    1: "hint.9l.l1",
    2: "hint.9l.l2",
    3: "hint.9l.l3",
    4: "hint.9l.l4",
    5: "hint.9l.l5",
    6: "hint.9l.l6",
    7: "hint.9l.l7",
    8: "hint.9l.l8",
    9: "hint.9l.l9"
  }
};
const hintMap = {
  "air-l1": "hint.air_l1",
  "air-l2": "hint.air_l2",
  "air-l3": "hint.air_l3",
  "air-l4": "hint.air_l4",
  "air-l5": "hint.air_l5",
  "air-l6": "hint.air_l6",
  "air-l7": "hint.air_l7",
  "air-present-0": "hint.air_present_1",
  "air-present-1": "hint.air_present_2",
  "air-present-2": "hint.air_present_3",
  "mission-present-0": "hint.mission_present_1",
  "mission-present-1": "hint.mission_present_2",
  "mission-present-2": "hint.mission_present_3",
  "air-clear-0": "hint.air_clear",
  "air-clear-1": "hint.air_clear",
  "air-clear-2": "hint.air_clear",
  "mission-clear-0": "hint.mission_clear",
  "mission-clear-1": "hint.mission_clear",
  "mission-clear-2": "hint.mission_clear",
  "cs-jtac": "hint.cs_jtac",
  "req-munition": "hint.req_munition",
  "castype-1": "hint.castype_1",
  "castype-2": "hint.castype_2",
  "castype-3": "hint.castype_3",
  "attackmethod-bot": "hint.attack_bot",
  "attackmethod-boc": "hint.attack_boc",
  "omit-l1-l3": "hint.omit_l1_l3",
  "include-remarks": "hint.include_remarks",
  "preauth-toggle": "hint.preauth",
  "killbox-toggle": "hint.killbox_toggle",
  "killbox-input": "hint.killbox_input",
  "allies-in-area-toggle": "hint.allies_in_area",
  "danger-close-toggle": "hint.danger_close",
  "danger-close-deg": "hint.danger_deg",
  "danger-close-dist": "hint.danger_dist",
  "vector-final-toggle": "hint.vector_final",
  "vector-final-deg": "hint.vector_deg",
  "vector-final-var": "hint.vector_var",
  "cas-remarks": "hint.cas_remarks"
};

// ====== Estado ======
let airStore = [{},{},{}];
let airPresent = [false,false,false];
let currentAir = 0;
let missionStore = [null,null,null];
let missionPresent = [false,false,false];
let currentMission = 0;
let suppressSave = false;

// ====== Persistencia ======
function loadState(){
  try{
    const s = localStorage.getItem('jtac_helper_state');
    if(s){
      const parsed = JSON.parse(s);
      if(Array.isArray(parsed.airStore) && parsed.airStore.length>=3) {
        airStore = parsed.airStore.map(a=>{
          if(!a) return {};
          if(a.l1||a.l2||a.l3) return a;
          const migrated = {
            l1: a.cs||'',
            l2: a.type||'',
            l3: a.pos||'',
            l4: a.weap||'',
            l5: a.time||'',
            l6: a.abort||a.sens||'',
            l7: a.remarks||a.fuel||''
          };
          return migrated;
        });
      }
      if(typeof parsed.currentAir === 'number') currentAir = parsed.currentAir;
      if(parsed.csJtac) csJtac.value = parsed.csJtac;
      if(parsed.csGround && csGround) csGround.value = parsed.csGround;
      if(Array.isArray(parsed.airPresent)) airPresent = parsed.airPresent;
      if(Array.isArray(parsed.missionStore)) missionStore = parsed.missionStore;
      if(Array.isArray(parsed.missionPresent)) missionPresent = parsed.missionPresent;
      if(typeof parsed.currentMission === 'number') currentMission = parsed.currentMission;
      if(parsed.liner) linerSelect.value = parsed.liner;
      if(typeof parsed.casModeRadio === 'boolean' && casModeRadioEl){
        casModeRadioEl.checked = parsed.casModeRadio;
      }
      if(parsed.castype){
        castypeEls.forEach(i=> i.checked = (i.value === parsed.castype));
      }
      if(parsed.attackmethod){
        attackMethodEls.forEach(i=> i.checked = (i.value === parsed.attackmethod));
      }
      if(parsed.req_munition) setSelectedMunitionList(parsed.req_munition);
      if(typeof parsed.omitL1L3 === 'boolean') omitL1L3El.checked = parsed.omitL1L3;
      if(parsed.casRemarks) casRemarksEl.value = parsed.casRemarks;
      if(typeof parsed.includeRemarks === 'boolean') includeRemarksEl.checked = parsed.includeRemarks;
      if(typeof parsed.vectorFinalEnabled === 'boolean') vectorFinalToggleEl.checked = parsed.vectorFinalEnabled;
      if(typeof parsed.vectorFinalDeg !== 'undefined') vectorFinalDegEl.value = parsed.vectorFinalDeg;
      if(typeof parsed.vectorFinalVar !== 'undefined') vectorFinalVarEl.value = parsed.vectorFinalVar;
      updateRemarksVisibility();
      if(parsed.openSections && typeof parsed.openSections === 'object'){
        document.querySelectorAll('details.section[data-section]').forEach(d=>{
          const k = d.getAttribute('data-section');
          if(typeof parsed.openSections[k] === 'boolean') d.open = parsed.openSections[k];
        });
      }
    }
  }catch(e){console.warn('loadState error',e)}
}

function saveState(){
  try{
    const state = {
      airStore,
      airPresent,
      currentAir,
      missionStore,
      missionPresent,
      currentMission,
      csJtac: csJtac.value,
      csGround: csGround?.value || '',
      liner: linerSelect?.value || '9',
      castype: castypeEls.find(c=>c.checked)?.value || '',
      attackmethod: attackMethodEls.find(a=>a.checked)?.value || '',
      req_munition: getSelectedMunitionList(),
      casRemarks: casRemarksEl?.value || ''
      ,omitL1L3: omitL1L3El?.checked || false
    };
    state.casModeRadio = !!casModeRadioEl?.checked;
    state.openSections = {};
    document.querySelectorAll('details.section[data-section]').forEach(d=> state.openSections[d.getAttribute('data-section')] = !!d.open );
    localStorage.setItem('jtac_helper_state', JSON.stringify(state));
  }catch(e){console.warn('saveState error',e)}
}

// ====== Guardar/Cargar misi√≥n ======
function saveMission(){
  const m = {
    liner: linerSelect?.value || '9',
    remarks: casRemarksEl?.value || '',
    includeRemarks: includeRemarksEl?.checked || false,
    reqMunition: getSelectedMunitionList(),
    attackmethod: attackMethodEls.find(a=>a.checked)?.value || '',
    preauth: preauthToggleEl?.checked || false,
    alliesInArea: alliesInAreaToggleEl?.checked || false,
    killbox: killboxToggleEl?.checked || false,
    killboxText: killboxInputEl?.value || '',
    dangerClose: dangerCloseToggleEl?.checked || false,
    dangerCloseDeg: dangerCloseDegEl?.value || '',
    dangerCloseDist: dangerCloseDistEl?.value || '',
    vectorFinalEnabled: vectorFinalToggleEl?.checked || false,
    vectorFinalDeg: vectorFinalDegEl?.value || '',
    vectorFinalVar: vectorFinalVarEl?.value || '',
    castype: castypeEls.find(c=>c.checked)?.value || ''
  };
  const inputs = [...linerFields.querySelectorAll('input[data-line]')];
  inputs.forEach(i=>{ if(!m.lines) m.lines = {}; m.lines[i.dataset.line] = i.value; });
  missionStore[currentMission] = m;
  saveState();
}

function loadMission(){
  const m = missionStore[currentMission] || {};
  if(m.liner) linerSelect.value = m.liner;
  const inputs = [...linerFields.querySelectorAll('input[data-line]')];
  inputs.forEach(i=> i.value = (m.lines && m.lines[i.dataset.line]) || '');
  casRemarksEl.value = m.remarks || '';
  renderMunitionOptions();
  if(m.reqMunition) setSelectedMunitionList(m.reqMunition);
  if(m.attackmethod){
    attackMethodEls.forEach(i=> i.checked = (i.value === m.attackmethod));
  } else {
    attackMethodEls.forEach(i=> i.checked = false);
  }
  if(includeRemarksEl) includeRemarksEl.checked = !!m.includeRemarks;
  if(preauthToggleEl) preauthToggleEl.checked = !!m.preauth;
  if(alliesInAreaToggleEl) alliesInAreaToggleEl.checked = !!m.alliesInArea;
  updateAlliesInAreaColor();
  if(killboxToggleEl) killboxToggleEl.checked = !!m.killbox;
  if(killboxInputEl) killboxInputEl.value = m.killboxText || '';
  if(dangerCloseToggleEl) dangerCloseToggleEl.checked = !!m.dangerClose;
  if(dangerCloseDegEl) dangerCloseDegEl.value = m.dangerCloseDeg || '';
  if(dangerCloseDistEl) dangerCloseDistEl.value = m.dangerCloseDist || '';
  if(vectorFinalToggleEl) vectorFinalToggleEl.checked = !!m.vectorFinalEnabled;
  if(vectorFinalDegEl) vectorFinalDegEl.value = m.vectorFinalDeg || '';
  if(vectorFinalVarEl) vectorFinalVarEl.value = m.vectorFinalVar || '';
  if(m.castype){
    castypeEls.forEach(i=> i.checked = (i.value === m.castype));
  } else {
    castypeEls.forEach(i=> i.checked = false);
  }
  updateLiner();
  updateCasTypeEffects();
  updateRemarksVisibility();
  updateVectorFinalVisibility();
  updateDangerCloseVisibility();
  updatePreauthVisibility();
}

// ====== Guardar/Cargar aeronave ======
function saveAir(){
  airStore[currentAir] = {
    l1: airL1.value,
    l2: airL2.value,
    l3: airL3.value,
    l4: airL4.value,
    l5: airL5.value,
    l6: airL6.value,
    l7: airL7.value
  };
  saveState();
}

function parseWeaponsList(){
  const raw = (airL4?.value || '').trim();
  if(!raw) return [];
  const parts = raw.split(',').map(p=>p.trim()).filter(Boolean);
  return [...new Set(parts)];
}

function getSelectedMunitionList(){
  if(!reqMunitionListEl) return [];
  const boxes = [...reqMunitionListEl.querySelectorAll('input[type="checkbox"]')];
  return boxes.filter(b=>b.checked).map(b=>{
    const qtyEl = reqMunitionListEl.querySelector(`input[data-munition-qty="${CSS.escape(b.value)}"]`);
    return {name: b.value, qty: (qtyEl?.value || '').trim()};
  });
}

function setSelectedMunitionList(list){
  if(!reqMunitionListEl) return;
  const selected = normalizeMunitionSelection(list);
  const boxes = [...reqMunitionListEl.querySelectorAll('input[type="checkbox"]')];
  if(!boxes.length){
    pendingMunitionSelection = selected;
    return;
  }
  const selectedNames = new Set(selected.map(s=>s.name));
  boxes.forEach(b=>{ b.checked = selectedNames.has(b.value); });
  selected.forEach(s=>{
    const qtyEl = reqMunitionListEl.querySelector(`input[data-munition-qty="${CSS.escape(s.name)}"]`);
    if(qtyEl) qtyEl.value = s.qty || '';
  });
}

function renderMunitionOptions(){
  if(!reqMunitionListEl) return;
  const weapons = parseWeaponsList();
  const selected = getSelectedMunitionList();
  const selectedNames = new Set(selected.map(s=>s.name));
  reqMunitionListEl.innerHTML = '';
  weapons.forEach(w=>{
    const label = document.createElement('label');
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.name = 'req-munition';
    input.value = w;
    if(selectedNames.has(w)) input.checked = true;
    input.addEventListener('change', saveMission);
    const qty = document.createElement('input');
    qty.type = 'number';
    qty.className = 'mun-qty';
    qty.setAttribute('data-munition-qty', w);
    qty.setAttribute('inputmode', 'numeric');
    qty.placeholder = 'N¬∞';
    qty.addEventListener('input', saveMission);
    const span = document.createElement('span');
    span.textContent = w;
    label.appendChild(input);
    label.appendChild(span);
    label.appendChild(qty);
    reqMunitionListEl.appendChild(label);
  });
  if(pendingMunitionSelection){
    const pending = pendingMunitionSelection;
    pendingMunitionSelection = null;
    setSelectedMunitionList(pending);
  } else if(selected.length){
    setSelectedMunitionList(selected);
  }
}

function normalizeMunitionSelection(list){
  if(Array.isArray(list)){
    return list.map(v=>{
      if(typeof v === 'string') return {name: v, qty: ''};
      if(v && typeof v === 'object') return {name: v.name || '', qty: v.qty || ''};
      return null;
    }).filter(v=>v && v.name);
  }
  if(typeof list === 'string'){
    return list.split('|').map(s=>s.trim()).filter(Boolean).map(name=>({name, qty:''}));
  }
  return [];
}

function loadAir(){
  const a = airStore[currentAir] || {};
  airL1.value = a.l1 || '';
  airL2.value = a.l2 || '';
  airL3.value = a.l3 || '';
  airL4.value = a.l4 || '';
  airL5.value = a.l5 || '';
  airL6.value = a.l6 || '';
  airL7.value = a.l7 || '';
}

function switchAir(){
  saveAir();
  loadAir();
  saveState();
}

// ====== Configurar inputs del liner seg√∫n 3/6/9 ======
function updateLiner(){
  const l = parseInt(linerSelect.value,10) || 9;
  const placeholders = {
    3: [
      'liner.3.1',
      'liner.3.2',
      'liner.3.3'
    ],
    6: [
      'liner.6.1',
      'liner.6.2',
      'liner.6.3',
      'liner.6.4',
      'liner.6.5',
      'liner.6.6'
    ],
    9: [
      'liner.9.1',
      'liner.9.2',
      'liner.9.3',
      'liner.9.4',
      'liner.9.5',
      'liner.9.6',
      'liner.9.7',
      'liner.9.8',
      'liner.9.9'
    ]
  };
  linerFields.querySelectorAll('input').forEach(i=>{
    i.classList.remove('hidden');
    const line = parseInt(i.dataset.line,10);
    if(!isNaN(line)) i.id = `${l}L-L${line}`;
    if(!isNaN(line) && linerHints[l] && linerHints[l][line]){
      i.dataset.hint = linerHints[l][line];
      i.title = t(linerHints[l][line]);
    }
    if(!isNaN(line) && line>l) i.classList.add('hidden');
    if(!isNaN(line) && line<=l){
      const key = (placeholders[l] && placeholders[l][line-1]) || '';
      const label = key ? t(key) : i.placeholder;
      i.placeholder = `L${line} ${label}`;
    }
    if(line === 3){
      i.type = (l === 3) ? 'text' : 'number';
    }
    if(omitL1L3El && omitL1L3El.checked && line >= 1 && line <= 3){
      i.disabled = true;
    } else {
      i.disabled = false;
    }
  });
  if(omitL1L3RowEl){
    const hideOmit = l === 6 || l === 3;
    omitL1L3RowEl.classList.toggle('hidden', hideOmit);
    if(hideOmit && omitL1L3El) omitL1L3El.checked = false;
  }
  applyUnitToUI();
  applyHoverHints();
  syncDangerCloseFromLine8();
}

function syncDangerCloseFromLine8(){
  const line8El = linerFields?.querySelector('input[data-line="8"]');
  if(!line8El || !dangerCloseDegEl || !dangerCloseDistEl) return;
  const raw = String(line8El.value || '').trim();
  if(!raw) return;
  // Accept radials like "090", "090/500", "90 500", "090-500"
  const m = raw.match(/^\s*(\d{1,3})(?:\s*[/\-\s]\s*(\d+))?\s*$/);
  if(!m) return;
  const deg = Number(m[1]);
  if(Number.isNaN(deg) || deg < 0 || deg > 360) return;
  dangerCloseDegEl.value = String(deg).padStart(3, '0');
  if(m[2]){
    dangerCloseDistEl.value = String(m[2]);
  }
  saveMission();
}

// ====== Inicializaci√≥n ======
loadState();
const storedLang = localStorage.getItem('jtac_lang');
const langCandidates = (navigator.languages && navigator.languages.length)
  ? navigator.languages
  : [navigator.language || ''];
const hasSpanish = langCandidates.some(l => String(l).toLowerCase().startsWith('es'));
const defaultLang = hasSpanish ? 'es' : 'en';
const initialLang = storedLang || defaultLang;
if(!storedLang) localStorage.setItem('jtac_lang', initialLang);
if(langSelectEl) langSelectEl.value = initialLang;
loadLang(initialLang);
const storedUnit = localStorage.getItem('jtac_unit') || 'm';
if(unitSelectEl) unitSelectEl.value = storedUnit;
applyUnitToUI();
langSelectEl?.addEventListener('change', ()=> loadLang(langSelectEl.value));
unitSelectEl?.addEventListener('change', ()=> setUnit(unitSelectEl.value));
updateLiner();
loadAir();
renderMunitionOptions();
  updateRemarksVisibility();
  updateVectorFinalVisibility();
  updateDangerCloseVisibility();
updateCasTypeEffects();
updateAlliesInAreaColor();
updateKillboxVisibility();

// ====== Aplicar estado de secciones abiertas ======
function applyOpenSectionsFromStorage(){
  try{
    const s = localStorage.getItem('jtac_helper_state');
    if(!s) return;
    const parsed = JSON.parse(s);
    if(parsed && parsed.openSections && typeof parsed.openSections === 'object'){
      suppressSave = true;
      document.querySelectorAll('details.section[data-section]').forEach(d=>{
        const k = d.getAttribute('data-section');
        if(typeof parsed.openSections[k] === 'boolean') d.open = parsed.openSections[k];
      });
      suppressSave = false;
    }
  }catch(e){console.warn('applyOpenSectionsFromStorage',e)}
}

// ====== Visibilidad de remarks y subcampos ======
function updateRemarksVisibility(){
  if(!remarksSection) return;
  if(includeRemarksEl && includeRemarksEl.checked){
    remarksSection.classList.remove('hidden');
  } else {
    remarksSection.classList.add('hidden');
  }
}

function updateVectorFinalVisibility(){
  if(!vectorFinalFieldsEl) return;
  const show = !!(vectorFinalToggleEl && vectorFinalToggleEl.checked);
  vectorFinalFieldsEl.classList.toggle('hidden', !show);
}

function updateDangerCloseVisibility(){
  if(!dangerCloseDegEl || !dangerCloseDistEl) return;
  const show = !!(dangerCloseToggleEl && dangerCloseToggleEl.checked);
  dangerCloseRowEl?.classList.toggle('danger', show);
  const allow = !!(alliesInAreaToggleEl && alliesInAreaToggleEl.checked);
  dangerCloseRowEl?.classList.toggle('hidden', !allow);
  if(dangerCloseDegEl) dangerCloseDegEl.classList.toggle('hidden', !show);
  if(dangerCloseDistEl) dangerCloseDistEl.classList.toggle('hidden', !show);
  if(!allow){
    if(dangerCloseDegEl) dangerCloseDegEl.classList.add('hidden');
    if(dangerCloseDistEl) dangerCloseDistEl.classList.add('hidden');
  }
}

function updatePreauthVisibility(){
  if(!preauthRowEl) return;
  const selected = castypeEls.find(c=>c.checked)?.value || '';
  const show = selected === 'Tipo 3';
  if(preauthLabelEl){
    if(show) preauthLabelEl.classList.remove('hidden');
    else preauthLabelEl.classList.add('hidden');
  }
  if(!show && preauthToggleEl) preauthToggleEl.checked = false;
  updateAlliesInAreaColor();
  updateKillboxVisibility();
}

function updateAlliesInAreaColor(){
  if(!alliesInAreaLabelEl) return;
  const on = !!(alliesInAreaToggleEl && alliesInAreaToggleEl.checked);
  alliesInAreaLabelEl.classList.toggle('ally-active', on);
}

function updateKillboxVisibility(){
  const show = !!(preauthToggleEl && preauthToggleEl.checked);
  if(killboxLabelEl) killboxLabelEl.classList.toggle('hidden', !show);
  if(killboxInputEl) killboxInputEl.classList.toggle('hidden', !(show && killboxToggleEl?.checked));
  if(!show && killboxToggleEl) killboxToggleEl.checked = false;
  if(killboxLabelEl) killboxLabelEl.classList.toggle('danger', !!killboxToggleEl?.checked);
  if(killboxInputEl) killboxInputEl.classList.toggle('danger', !!killboxToggleEl?.checked);
  if(preauthRowEl) preauthRowEl.classList.toggle('compact', !(preauthToggleEl && preauthToggleEl.checked));
}

// ====== Reglas por tipo de CAS ======
function updateCasTypeEffects(){
  const selected = castypeEls.find(c=>c.checked)?.value || '';
  const opt3 = linerSelect?.querySelector('option[value="3"]');
  const opt6 = linerSelect?.querySelector('option[value="6"]');
  const opt9 = linerSelect?.querySelector('option[value="9"]');
  const isTipo3 = selected === 'Tipo 3';
  const isTipo1 = selected === 'Tipo 1';
  if(opt3) opt3.disabled = !isTipo3;
  if(opt6) opt6.disabled = isTipo3;
  if(opt9) opt9.disabled = isTipo3;
  if(isTipo3){
    linerSelect.value = '3';
    updateLiner();
  } else if(linerSelect?.value === '3'){
    linerSelect.value = '9';
    updateLiner();
  }
  if(attackMethodBlockEl){
    attackMethodBlockEl.classList.toggle('hidden', isTipo3);
    if(isTipo3){
      attackMethodEls.forEach(i=> i.checked = false);
    }
    attackMethodEls.forEach(i=>{
      if(i.value === 'BOC'){
        i.disabled = isTipo1;
        if(isTipo1) i.checked = false;
      }
    });
    if(isTipo1){
      attackMethodEls.forEach(i=>{ if(i.value === 'BOT') i.checked = true; });
    }
  }
  if(omitL1L3RowEl){
    const isL6 = linerSelect?.value === '6';
    const hideOmit = isTipo3 || isL6;
    omitL1L3RowEl.classList.toggle('hidden', hideOmit);
    if(hideOmit && omitL1L3El) omitL1L3El.checked = false;
  }
  updatePreauthVisibility();
}

airPresentEls.forEach((el,idx)=>{
  if(!el) return;
  el.checked = !!airPresent[idx];
  el.addEventListener('change', ()=>{
    if(suppressSave) return;
    if(el.checked){
      airPresentEls.forEach((o,j)=>{ if(j!==idx && o){ o.checked = false; airPresent[j]=false; }});
      airPresent[idx]=true;
      currentAir = idx;
    } else {
      el.checked = true;
      airPresent[idx]=true;
    }
    loadAir();
    saveState();
  });
});

if(!airPresent.some(Boolean) && airPresentEls[0]){ airPresent[0]=true; airPresentEls[0].checked=true; currentAir=0; }
['air-clear-0','air-clear-1','air-clear-2'].forEach((id,idx)=>{
  const b = document.getElementById(id);
  if(!b) return;
  b.addEventListener('click', (e)=>{
    e.preventDefault();
    airStore[idx] = {};
    if(currentAir===idx) loadAir();
    saveState();
  });
});

missionPresentEls.forEach((el,idx)=>{
  if(!el) return;
  el.checked = !!missionPresent[idx];
  el.addEventListener('change', ()=>{
    if(suppressSave) return;
    if(el.checked){
      missionPresentEls.forEach((o,j)=>{ if(j!==idx && o){ o.checked = false; missionPresent[j]=false; }});
      missionPresent[idx]=true;
      currentMission = idx;
    } else {
      el.checked = true;
      missionPresent[idx]=true;
    }
    loadMission();
    saveState();
  });
});
if(!missionPresent.some(Boolean) && missionPresentEls[0]){ missionPresent[0]=true; missionPresentEls[0].checked=true; currentMission=0; }
if(missionStore[currentMission]) loadMission();
['mission-clear-0','mission-clear-1','mission-clear-2'].forEach((id,idx)=>{
  const b = document.getElementById(id);
  if(!b) return;
  b.addEventListener('click', (e)=>{
    e.preventDefault();
    missionStore[idx] = null;
    if(currentMission===idx) loadMission();
    saveState();
  });
});

document.querySelectorAll('details.section[data-section]').forEach(d=> d.addEventListener('toggle', saveState));
applyOpenSectionsFromStorage();
window.addEventListener('beforeunload', saveState);
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState === 'hidden') saveState(); });

// ====== Hold-to-clear ======
if(clearBtnEl){
  let clearHoldTimer = null;
  const startHold = () => {
    if(clearHoldTimer) return;
    clearBtnEl.classList.add('holding');
    clearHoldTimer = setTimeout(()=>{
      clearHoldTimer = null;
      clearBtnEl.classList.remove('holding');
      clearAll();
    }, 1000);
  };
  const cancelHold = () => {
    if(clearHoldTimer){
      clearTimeout(clearHoldTimer);
      clearHoldTimer = null;
    }
    clearBtnEl.classList.remove('holding');
  };
  clearBtnEl.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startHold(); });
  clearBtnEl.addEventListener('pointerup', cancelHold);
  clearBtnEl.addEventListener('pointerleave', cancelHold);
  clearBtnEl.addEventListener('pointercancel', cancelHold);
  clearBtnEl.addEventListener('blur', cancelHold);
  clearBtnEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); startHold(); }
  });
  clearBtnEl.addEventListener('keyup', (e)=>{
    if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); cancelHold(); }
  });
}

// ====== Eventos de inputs ======
castypeEls.forEach(cb=>{
  cb.addEventListener('change',()=>{
    castypeEls.forEach(o=>{ if(o!==cb) o.checked=false; });
    updateCasTypeEffects();
    saveMission();
  });
});

attackMethodEls.forEach(cb=>{
  cb.addEventListener('change',()=>{
    attackMethodEls.forEach(o=>{ if(o!==cb) o.checked=false; });
    saveMission();
  });
});

csJtac?.addEventListener('input', saveState);
csGround?.addEventListener('input', saveState);
linerSelect?.addEventListener('change', ()=>{ updateLiner(); saveState(); });
omitL1L3El?.addEventListener('change', ()=>{ updateLiner(); saveState(); });
casRemarksEl?.addEventListener('input', saveMission);
includeRemarksEl?.addEventListener('change', ()=>{ updateRemarksVisibility(); saveMission(); });
dangerCloseToggleEl?.addEventListener('change', ()=>{ updateDangerCloseVisibility(); saveMission(); });
dangerCloseDegEl?.addEventListener('input', saveMission);
dangerCloseDistEl?.addEventListener('input', saveMission);
preauthToggleEl?.addEventListener('change', ()=>{ updateKillboxVisibility(); saveMission(); });
alliesInAreaToggleEl?.addEventListener('change', ()=>{ updateAlliesInAreaColor(); updateDangerCloseVisibility(); saveMission(); });
killboxToggleEl?.addEventListener('change', ()=>{ updateKillboxVisibility(); saveMission(); });
killboxInputEl?.addEventListener('input', saveMission);
vectorFinalToggleEl?.addEventListener('change', ()=>{ updateVectorFinalVisibility(); saveMission(); });
vectorFinalDegEl?.addEventListener('input', saveMission);
vectorFinalVarEl?.addEventListener('input', saveMission);

// ====== Validaci√≥n de inputs num√©ricos con min/max ======
function clampNumericInput(el){
  if(!el) return;
  const raw = el.value;
  if(raw === '') return;
  const minAttr = el.getAttribute('min');
  const maxAttr = el.getAttribute('max');
  const min = minAttr === null ? NaN : Number(minAttr);
  const max = maxAttr === null ? NaN : Number(maxAttr);
  let num = Number(raw);
  if(Number.isNaN(num)) return;
  if(!Number.isNaN(min) && num < min) num = min;
  if(!Number.isNaN(max) && num > max) num = max;
  if(String(num) !== raw) el.value = String(num);
}

// ====== Validaci√≥n en vivo de inputs num√©ricos ======
[...document.querySelectorAll('input[type="number"][min][max]')].forEach(el=>{
  el.addEventListener('input', ()=> clampNumericInput(el));
  el.addEventListener('blur', ()=> clampNumericInput(el));
});

// ====== Men√∫ lateral ======
if(menuBtn && leftPanel){
  menuBtn.addEventListener('click', ()=>{
    const isOpen = leftPanel.classList.toggle('open');
    menuBackdrop?.classList.toggle('show', isOpen);
    if(!isOpen){
      document.querySelectorAll('.submenu-panel').forEach(p=> p.classList.remove('open'));
    }
  });
}

document.querySelectorAll('.menu-btn-box').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.getAttribute('data-submenu');
    document.querySelectorAll('.submenu-panel').forEach(p=> p.classList.remove('open'));
    const panel = id ? document.getElementById(id) : null;
    if(panel) panel.classList.add('open');
    menuBackdrop?.classList.add('show');
  });
});

menuBackdrop?.addEventListener('click', ()=>{
  leftPanel?.classList.remove('open');
  document.querySelectorAll('.submenu-panel').forEach(p=> p.classList.remove('open'));
  menuBackdrop.classList.remove('show');
});

document.querySelectorAll('.back-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.getAttribute('data-back');
    if(id){
      const panel = document.getElementById(id);
      panel?.classList.remove('open');
    }
  });
});

// ====== Importar / Exportar ======
function buildExportPayload(){
  return {
    version: 2,
    lang: localStorage.getItem('jtac_lang') || 'es',
    unit: localStorage.getItem('jtac_unit') || 'm',
    state: localStorage.getItem('jtac_helper_state') || '',
    form: captureFormSnapshot()
  };
}

function captureFormSnapshot(){
  const byId = {};
  const byName = {};
  document.querySelectorAll('input, select, textarea').forEach(el=>{
    if(el.name){
      if(el.type === 'radio'){
        if(el.checked) byName[el.name] = el.value;
      } else if(el.type === 'checkbox'){
        if(!Array.isArray(byName[el.name])) byName[el.name] = [];
        if(el.checked) byName[el.name].push(el.value || 'on');
      }
    }
    if(!el.id) return;
    if(el.type === 'checkbox' || el.type === 'radio'){
      byId[el.id] = {type: 'check', value: !!el.checked};
    } else {
      byId[el.id] = {type: 'value', value: el.value};
    }
  });
  return {byId, byName};
}

function applyFormSnapshot(snapshot){
  if(!snapshot || typeof snapshot !== 'object') return;
  const byId = snapshot.byId || {};
  const byName = snapshot.byName || {};
  Object.keys(byId).forEach(id=>{
    const entry = byId[id];
    const el = document.getElementById(id);
    if(!el || !entry) return;
    if(entry.type === 'check'){
      el.checked = !!entry.value;
    } else if(entry.type === 'value'){
      el.value = entry.value ?? '';
    }
  });
  Object.keys(byName).forEach(name=>{
    const val = byName[name];
    const inputs = document.querySelectorAll(`[name="${name}"]`);
    inputs.forEach(el=>{
      if(el.type === 'radio'){
        el.checked = (el.value === val);
      } else if(el.type === 'checkbox'){
        const list = Array.isArray(val) ? val : [];
        const key = el.value || 'on';
        el.checked = list.includes(key);
      }
    });
  });
}

function applyImportedState(payload){
  if(!payload) throw new Error('invalid payload');
  // Allow raw state JSON, wrapped payload, or stringified payload
  if(typeof payload === 'string'){
    try{
      payload = JSON.parse(payload);
    }catch{
      throw new Error('invalid payload');
    }
  }
  if(typeof payload !== 'object') throw new Error('invalid payload');
  if(typeof payload.lang === 'string' && payload.lang){
    localStorage.setItem('jtac_lang', payload.lang);
  }
  if(typeof payload.unit === 'string' && payload.unit){
    localStorage.setItem('jtac_unit', payload.unit);
  }
  if(typeof payload.state === 'string'){
    localStorage.setItem('jtac_helper_state', payload.state);
  } else if(typeof payload.state === 'object' && payload.state !== null){
    localStorage.setItem('jtac_helper_state', JSON.stringify(payload.state));
  } else if(payload.airStore || payload.missionStore || payload.openSections){
    // Treat as raw state object
    localStorage.setItem('jtac_helper_state', JSON.stringify(payload));
  }
  loadState();
  renderMunitionOptions();
  if(payload.form) applyFormSnapshot(payload.form);
  else if(payload.state && payload.state.req_munition) setSelectedMunitionList(payload.state.req_munition);
  const stored = localStorage.getItem('jtac_lang') || 'es';
  if(langSelectEl) langSelectEl.value = stored;
  loadLang(stored);
  refreshUIAfterImport();
}

function refreshUIAfterImport(){
  updateLiner();
  loadAir();
  loadMission();
  updateCasTypeEffects();
  updateRemarksVisibility();
  updateVectorFinalVisibility();
  updateDangerCloseVisibility();
  updatePreauthVisibility();
  updateAlliesInAreaColor();
  updateKillboxVisibility();
  applyOpenSectionsFromStorage();
  const mode = casModeRadioEl && casModeRadioEl.checked ? 'radio' : 'texto';
  if(casOutput) genCAS(mode);
}

if(exportBtnEl && importExportTextEl){
  exportBtnEl.addEventListener('click', ()=>{
    const panel = exportBtnEl.closest('.submenu-panel');
    panel?.classList.add('open');
    menuBackdrop?.classList.add('show');
    saveAir();
    saveMission();
    saveState();
    const payload = buildExportPayload();
    importExportTextEl.value = JSON.stringify(payload, null, 2);
    importExportTextEl.focus();
    importExportTextEl.select();
  });
}

if(importBtnEl && importExportTextEl){
  importBtnEl.addEventListener('click', ()=>{
    const panel = importBtnEl.closest('.submenu-panel');
    panel?.classList.add('open');
    menuBackdrop?.classList.add('show');
    const raw = (importExportTextEl.value || '').trim();
    if(!raw) return alert(t('import.error_empty'));
    try{
      const payload = JSON.parse(raw);
      applyImportedState(payload);
      alert(t('import.success'));
    }catch(e){
      console.warn('import error', e);
      alert(t('import.error_invalid'));
    }
  });
}

[airL1,airL2,airL3,airL4,airL5,airL6,airL7].forEach(el=>{ if(el) el.addEventListener('input', saveAir); });
airL4?.addEventListener('input', ()=>{ renderMunitionOptions(); saveMission(); });
[...linerFields.querySelectorAll('input[data-line]')].forEach(i=> i.addEventListener('input', saveMission));
linerFields?.addEventListener('input', (e)=>{
  const t = e.target;
  if(t && t.dataset && t.dataset.line === '8'){
    syncDangerCloseFromLine8();
  }
});
linerFields?.addEventListener('change', (e)=>{
  const t = e.target;
  if(t && t.dataset && t.dataset.line === '8'){
    syncDangerCloseFromLine8();
  }
});

// ====== Hints por hover ======
// ====== Idioma ======
async function loadLang(lang){
  const safe = lang || 'es';
  try{
    const res = await fetch(`lang/${safe}.json`, {cache: 'no-cache'});
    if(!res.ok) throw new Error(`lang load ${safe}: ${res.status}`);
    translations = await res.json();
    currentLang = safe;
    localStorage.setItem('jtac_lang', safe);
    applyLang();
  }catch(e){
    console.warn('loadLang error', e);
  }
}

function applyLang(){
  document.title = t('app.title');
  document.documentElement.setAttribute('lang', currentLang);
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if(key) el.textContent = t(key);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
    const key = el.getAttribute('data-i18n-placeholder');
    if(key) el.setAttribute('placeholder', t(key));
  });
  document.querySelectorAll('[data-i18n-title]').forEach(el=>{
    const key = el.getAttribute('data-i18n-title');
    if(key) el.setAttribute('title', t(key));
  });
  updateLiner();
  applyUnitToUI();
  applyHoverHints();
  renderDictionaryPage();
}

function applyHoverHints(){
  const excludeIds = new Set(['cas-mode-radio']);
  document.querySelectorAll('input, select, textarea, button').forEach(el=>{
    if(excludeIds.has(el.id)) return;
    if(el.dataset && el.dataset.hint){
      el.title = t(el.dataset.hint);
      return;
    }
    if(el.id && hintMap[el.id]){
      el.title = t(hintMap[el.id]);
      return;
    }
    if(el.title) return;
    if(el.tagName === 'INPUT' && (el.type === 'checkbox' || el.type === 'radio')){
      const label = el.closest('label');
      if(label){
        if(label.getAttribute('for') && excludeIds.has(label.getAttribute('for'))) return;
        const text = label.textContent.replace(/\s+/g, ' ').trim();
        if(text) el.title = text;
      }
      return;
    }
    const ph = el.getAttribute('placeholder');
    if(ph) el.title = ph;
  });
  document.querySelectorAll('label').forEach(label=>{
    const forId = label.getAttribute('for');
    if(forId && excludeIds.has(forId)) return;
    const embedded = label.querySelector('input[id]');
    if(embedded && embedded.id && hintMap[embedded.id]){
      label.title = t(hintMap[embedded.id]);
      return;
    }
    if(label.title) return;
    const text = label.textContent.replace(/\s+/g, ' ').trim();
    if(text) label.title = text;
  });
}

// ====== Dictionary pagination ======
const dictKeys = [
  'dict.visual',
  'dict.blind',
  'dict.tally',
  'dict.nojoy',
  'dict.contact',
  'dict.captured'
];
let dictPage = 0;
let dictPageSize = 3;

function renderDictionaryPage(){
  if(!dictListEl) return;
  // Compute items per page based on available height
  const panel = dictListEl.closest('.submenu-panel');
  const header = panel?.querySelector('.submenu-header');
  const nav = dictPrevEl?.parentElement;
  const panelH = panel?.clientHeight || 0;
  const headerH = header?.offsetHeight || 0;
  const navH = nav?.offsetHeight || 0;
  const available = Math.max(0, panelH - headerH - navH - 16);
  if(available > 0){
    dictListEl.style.maxHeight = `${available}px`;
    // measure a probe item
    const probe = document.createElement('div');
    probe.className = 'dict-item';
    probe.textContent = t(dictKeys[0] || '');
    dictListEl.appendChild(probe);
    const itemHeight = probe.getBoundingClientRect().height || 44;
    dictListEl.removeChild(probe);
    dictPageSize = Math.max(1, Math.floor(available / itemHeight));
  }
  const start = dictPage * dictPageSize;
  const pageItems = dictKeys.slice(start, start + dictPageSize);
  dictListEl.innerHTML = '';
  pageItems.forEach(k=>{
    const div = document.createElement('div');
    div.className = 'dict-item';
    div.textContent = t(k);
    dictListEl.appendChild(div);
  });
  if(dictPrevEl) dictPrevEl.disabled = dictPage === 0;
  if(dictNextEl) dictNextEl.disabled = (start + dictPageSize) >= dictKeys.length;
  if(dictPageIndicatorEl){
    const totalPages = Math.max(1, Math.ceil(dictKeys.length / dictPageSize));
    dictPageIndicatorEl.textContent = `${dictPage + 1} / ${totalPages}`;
  }
}

if(dictPrevEl){
  dictPrevEl.addEventListener('click', ()=>{
    dictPage = Math.max(0, dictPage - 1);
    renderDictionaryPage();
  });
}
if(dictNextEl){
  dictNextEl.addEventListener('click', ()=>{
    const maxPage = Math.floor((dictKeys.length - 1) / dictPageSize);
    dictPage = Math.min(maxPage, dictPage + 1);
    renderDictionaryPage();
  });
}

window.addEventListener('resize', renderDictionaryPage);

function applyUnitToUI(){
  const unit = getUnit();
  if(unitSelectEl) unitSelectEl.value = unit;
  const distKey = unit === 'ft' ? 'remarks.feet' : 'remarks.meters';
  if(dangerCloseDistEl) dangerCloseDistEl.setAttribute('placeholder', t(distKey));
  if(dangerCloseDistEl) dangerCloseDistEl.title = t(distKey);
  const liner = linerSelect?.value || '9';
  if(liner === '6' || liner === '9'){
    const line3 = linerFields?.querySelector('input[data-line="3"]');
    if(line3){
      const phKey = unit === 'ft' ? 'liner.distance_ft' : 'liner.distance_m';
      const hintKey = unit === 'ft' ? 'hint.distance_ft' : 'hint.distance_m';
      line3.setAttribute('placeholder', `L3 ${t(phKey)}`);
      line3.dataset.hint = hintKey;
      line3.title = t(hintKey);
    }
  }
}

// ====== Generaci√≥n de salida ======
if(casGenBtn){
  casGenBtn.addEventListener('click', ()=>{
    const mode = casModeRadioEl && casModeRadioEl.checked ? 'radio' : 'texto';
    genCAS(mode);
  });
  if(casModeRadioEl) casModeRadioEl.addEventListener('change', saveState);
}

if(casOutput){
  casOutput.addEventListener('keydown', (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'a'){
      e.preventDefault();
      const range = document.createRange();
      range.selectNodeContents(casOutput);
      const sel = window.getSelection();
      if(sel){
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
  });
}

function genCAS(mode){
  saveAir();
  const jtac = (csJtac.value || '').trim() || t('callsign.jtac_default');
  const liner = parseInt(linerSelect.value,10) || 9;
  const control = castypeEls.find(c=>c.checked)?.value || '';
  const attack = attackMethodEls.find(a=>a.checked)?.value || '';
  const munition = getSelectedMunitionList()
    .map(m=> m.qty ? `${m.qty}x${m.name}` : m.name)
    .join(' | ');
  const castype = control || t('cas.default_type');
  const activeAir = airStore[currentAir] || {};
  const fields = [...linerFields.querySelectorAll('input[data-line]')].filter(i=>!i.classList.contains('hidden') && !i.disabled && i.value.trim() !== '');
  const remarks = (casRemarksEl?.value || '').trim();
  let out = '';
  const formatLine6 = (val) => {
    const digits = (val || '').replace(/\D/g,'');
    if(!(digits.length === 6 || digits.length === 8 || digits.length === 10)) return val;
    const half = digits.length / 2;
    const first = digits.slice(0, half);
    const last = digits.slice(-half);
    return `[ X${first} | Y${last} ]`;
  };
  const formatWeapons = (val) => {
    const raw = (val || '').trim();
    if(!raw) return '';
    const parts = raw.split(',').map(p=>p.trim()).filter(Boolean);
    return parts.join(' | ');
  };
  const toCompass = (deg) => {
    if(isNaN(deg)) return '';
    const dirs = ['N','NE','E','SE','S','SW','W','NW','N'];
    const idx = Math.round(((deg % 360) / 45));
    return dirs[idx];
  };
  const padLeadingZero = (rawVal) => {
    if(rawVal === null || rawVal === undefined) return '';
    const raw = String(rawVal).trim();
    if(raw === '') return '';
    if(raw.startsWith('0')) return raw;
    const num = Number(raw);
    if(Number.isNaN(num)) return raw;
    return num < 99 ? `0${raw}` : raw;
  };
  const formatHeading = (val) => {
    if(val === null || val === undefined) return '';
    const raw = String(val).trim();
    if(raw === '') return '';
    const num = Number(raw);
    if(Number.isNaN(num)) return val;
    const shown = padLeadingZero(raw);
    const dir = toCompass(num);
    return `${t('cas.heading_prefix')} ${dir} ${shown}\&deg;`;
  };
  const formatDirection = (val, label) => {
    if(val === null || val === undefined) return '';
    const raw = String(val).trim();
    if(raw === '') return '';
    const num = Number(raw);
    if(Number.isNaN(num)) return '';
    const shown = padLeadingZero(raw);
    const dir = toCompass(num);
    return label ? `${label} ${dir} ${shown}\&deg;` : `${dir} ${shown}\&deg;`;
  };
  const formatDirectionOrText = (val, label) => {
    if(val === null || val === undefined) return '';
    const raw = String(val).trim();
    if(raw === '') return '';
    const num = Number(raw);
    if(Number.isNaN(num)) return label ? `${label} ${raw}` : raw;
    const shown = padLeadingZero(raw);
    const dir = toCompass(num);
    return label ? `${label} ${dir} ${shown}\&deg;` : `${dir} ${shown}\&deg;`;
  };
  const formatDistance = (val) => {
    if(val === null || val === undefined) return '';
    const raw = String(val).trim();
    if(raw === '') return '';
    const num = Number(raw);
    if(Number.isNaN(num)) return val;
    const unit = getUnit();
    if(unit === 'ft'){
      const ft = Math.round(num);
      if(ft >= 5280){
        const mi = ft / 5280;
        const shown = Math.round(mi * 100) / 100;
        return t('cas.distance_mi', {mi: shown});
      }
      return t('cas.distance_ft', {ft});
    }
    if(num >= 1000){
      const km = num / 1000;
      return t('cas.distance_km', {km});
    }
    return t('cas.distance_m', {m: raw});
  };
  const formatVectorFinal = () => {
    if(!vectorFinalToggleEl?.checked) return '';
    const degVal = (vectorFinalDegEl?.value || '').trim();
    const degRaw = parseFloat(degVal);
    if(isNaN(degRaw)) return '';
    const dir = toCompass(degRaw);
    const shownDeg = padLeadingZero(degVal);
    const varVal = (vectorFinalVarEl?.value || '').trim();
    const varRaw = parseFloat(varVal);
    const shownVar = padLeadingZero(varVal);
    const varPart = !isNaN(varRaw) ? ` &plusmn; ${shownVar}&deg;` : '';
    return t('cas.vector_final', {dir, deg: `${shownDeg}&deg;`, var: varPart}).trim();
  };
  const formatDangerClose = () => {
    if(!dangerCloseToggleEl?.checked) return '';
    if(!alliesInAreaToggleEl?.checked) return '';
    const degVal = (dangerCloseDegEl?.value || '').trim();
    const distVal = (dangerCloseDistEl?.value || '').trim();
    const parts = [];
    const degRaw = parseFloat(degVal);
    if(!isNaN(degRaw)){
      const dir = toCompass(degRaw);
      const shownDeg = padLeadingZero(degVal);
      parts.push(t('cas.allies_direction', {dir, deg: `${shownDeg}&deg;`}));
    }
    const distRaw = parseFloat(distVal);
    if(!isNaN(distRaw)){
      parts.push(formatDistance(distVal));
    }
    const initials = getInitials((csGround?.value || '').trim());
    const prefix = t('cas.danger_close_authorized');
    const extra = initials ? `${t('cas.ground_cmd_initials', {initials})}, ` : '';
    const tail = parts.length ? parts.join(', ') : '';
    const colored = `${prefix}${extra}${tail}`.replace(/, /g, '</span>, <span class="danger">');
    return `<span class="danger">${colored}</span>`;
  };
  const getInitials = (raw) => {
    if(!raw) return '';
    const parts = raw.split(/\s+/).filter(Boolean);
    const initials = parts.slice(0,3).map(p=> p[0].toUpperCase()).join('.');
    return initials ? `${initials}.` : '';
  };
  const escapeRegExp = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const replaceInTextNodes = (html, re, replacement) => {
    return html.split(/(<[^>]+>)/g).map((part, i) => {
      if(i % 2) return part;
      return part.replace(re, replacement);
    }).join('');
  };
  const colorizeCallsigns = (html, jtacCall, airCall) => {
    let outHtml = html;
    const protectedSpans = [];
    outHtml = outHtml.replace(/<span class="(?:jtac|air)">.*?<\/span>/g, (m)=>{
      protectedSpans.push(m);
      return `__PROT${protectedSpans.length-1}__`;
    });
    if(jtacCall){
      const re = new RegExp(escapeRegExp(jtacCall), 'g');
      outHtml = replaceInTextNodes(outHtml, re, `<span class="jtac">${jtacCall}</span>`);
    }
    if(airCall){
      const re = new RegExp(escapeRegExp(airCall), 'g');
      outHtml = replaceInTextNodes(outHtml, re, `<span class="air">${airCall}</span>`);
    }
    outHtml = outHtml.replace(/__PROT(\d+)__/g, (_, idx)=> protectedSpans[Number(idx)] || '');
    return outHtml;
  };

  const map = {};
  fields.forEach(i=> map[i.dataset.line] = i.value);

  if(mode === 'radio'){
    const a = activeAir;
    const chkParts = [];
    if(a.l2) chkParts.push(a.l2);
    if(a.l4) chkParts.push(formatWeapons(a.l4));
    if(a.l5) chkParts.push(t('radio.playtime', {mikes: a.l5}));
    if(a.l6) chkParts.push(t('radio.abort_code', {code: a.l6}));
    if(a.l1) {
      out += `<span class="air">${a.l1}</span>:`;
      if(chkParts.length) out += ` ${chkParts.join(', ')}`;
      out += `.<br>`;
      if(a.l7) out += `${t('radio.remarks')}: ${a.l7}.<br>`;
    }
    out += `<span class="jtac">${jtac}</span>: ${t('radio.checkin_ack')}<br><br>`;

    out += `<span class="jtac">${jtac}</span>: ${t('radio.call_gameplan', {air: a.l1 || t('radio.air_default'), jtac})}<br>`;
    out += `<span class="air">${a.l1 || t('radio.air_default')}</span>: ${t('radio.ready_gameplan', {air: a.l1 || t('radio.air_default')})}<br><br>`;

    const gpParts = [];
    if(control){
      const ctlLabel = control === 'Tipo 1' ? t('gameplan.cas_type_1') : control === 'Tipo 2' ? t('gameplan.cas_type_2') : control === 'Tipo 3' ? t('gameplan.cas_type_3') : control;
      gpParts.push(`${t('radio.control')} ${ctlLabel}`);
    }
    if(attack) gpParts.push(attack === 'BOT' ? t('gameplan.bot') : attack === 'BOC' ? t('gameplan.boc') : attack);
    if(munition) gpParts.push(munition);
    out += `<span class="jtac">${jtac}</span>: ${t('radio.gameplan', {air: a.l1 || t('radio.air_default'), jtac, details: gpParts.length ? `, ${gpParts.join(', ')}` : '', liner})}<br><br>`;

    out += `<span class="air">${a.l1 || t('radio.air_default')}</span>: ${t('radio.ready_liner', {air: a.l1 || t('radio.air_default'), liner})}<br><br>`;

    const lineParts = [];
    if(omitL1L3El?.checked){
      lineParts.push(t('cas.lines_1_3_overhead'));
    } else if(liner === 3){
      const parts = [];
      if(map[1]) parts.push(formatLine6(map[1]));
      if(map[2]) parts.push(map[2]);
      if(map[3]) parts.push(`${t('cas.allies')} ${map[3]}`);
      if(parts.length) lineParts.push(parts.join(', '));
    } else {
      if(map[1]) lineParts.push(map[1]);
      if(map[2]) lineParts.push(formatHeading(map[2]));
      if(map[3]) lineParts.push(formatDistance(map[3]));
    }
    if(map[4]) lineParts.push(`${t('cas.elevation')} ${map[4]}`);
    if(map[5]) lineParts.push(map[5]);
    if(map[6]) lineParts.push(`${t('cas.coordinates')} ${formatLine6(map[6])}`);
    if(map[7]) lineParts.push(`${t('cas.marked_with')} ${map[7]}`);
    if(map[8]) lineParts.push(control === 'Tipo 3' ? `${t('cas.allies')} ${map[8]}` : formatDirectionOrText(map[8], t('cas.allies')));
    if(map[9]) lineParts.push(control === 'Tipo 3' ? `${t('cas.egress')} ${map[9]}` : formatDirection(map[9], t('cas.egress')));
    const vec = formatVectorFinal();
    const killboxName = (killboxInputEl?.value || '').trim();
    const preauth = preauthToggleEl?.checked ? (killboxToggleEl?.checked && killboxName ? t('cas.preauth_killbox', {killbox: `<span class="danger">${t('cas.killbox')} ${killboxName}</span>`}) : t('cas.preauth')) : '';
    const killbox = (!preauth && killboxToggleEl?.checked && killboxName) ? `<span class="danger">${t('cas.killbox')} ${killboxName}</span>` : '';
    const allies = alliesInAreaToggleEl?.checked ? `<span class="ally-text">${t('cas.allies_in_area')}</span>` : '';
    const danger = formatDangerClose();
    if(includeRemarksEl?.checked && (preauth || allies || danger || vec || remarks)) lineParts.push(t('cas.remarks_label'));
    if(includeRemarksEl?.checked && preauth) lineParts.push(preauth);
    if(includeRemarksEl?.checked && killbox) lineParts.push(killbox);
    if(includeRemarksEl?.checked && allies) lineParts.push(allies);
    if(includeRemarksEl?.checked && danger) lineParts.push(danger);
    if(includeRemarksEl?.checked && vec) lineParts.push(vec);
    if(includeRemarksEl?.checked && remarks) lineParts.push(`${t('cas.remarks_word')} ${remarks}`);
    out += `<span class="jtac">${jtac}</span>: ${liner}-line` + (lineParts.length ? `, ${lineParts.join(', ')}` : '') + `, ${t('cas.ready_readback')}.`;
    out = out.replace(`, ${t('cas.remarks_label')}`, `; ${t('cas.remarks_label')}`);
  }else{
    out += `<span class="jtac">${t('text.jtac_label')}</span> ${jtac}<br><br>`;
//    out += `${castype}<br><br>`;
    if(activeAir.l1){
      const airParts = [];
      if(activeAir.l2) airParts.push(activeAir.l2);
      if(activeAir.l4) airParts.push(formatWeapons(activeAir.l4));
    if(activeAir.l5) airParts.push(t('radio.playtime', {mikes: activeAir.l5}));
      if(activeAir.l6) airParts.push(t('radio.abort_code_short', {code: activeAir.l6}));
      out += `<span class="air">${activeAir.l1}</span>: ${airParts.join(', ')}.<br>`;
      if(activeAir.l7) out += `${t('text.remarks_label')}: ${activeAir.l7}.<br>`;
    }
    if(control || attack || munition){
      out += `<b>${t('text.gameplan_title')}</b><br>`;
      if(control){
        const ctlLabel = control === 'Tipo 1' ? t('gameplan.cas_type_1') : control === 'Tipo 2' ? t('gameplan.cas_type_2') : control === 'Tipo 3' ? t('gameplan.cas_type_3') : control;
        out += `${t('text.control_type')}: ${ctlLabel}<br>`;
      }
      if(attack === 'BOT') out += `${t('text.attack_method')}: ${t('gameplan.bot')}<br>`;
      if(attack === 'BOC') out += `${t('text.attack_method')}: ${t('gameplan.boc')}<br>`;
      if(munition) out += `${t('text.requested_munition')}: ${munition}<br>`;
      out += `<br>`;
    }
    out += `${t('text.cas_line', {liner})}<br>`;
    if(liner === 3){
      const m1 = map[1] ? formatLine6(map[1]) : '';
      const m2 = map[2] || '';
      const m3 = map[3] ? `${t('cas.allies')} ${map[3]}` : '';
      const parts = [m1,m2,m3].filter(Boolean);
      if(parts.length) out += `- ${parts.join(', ')}<br>`;
    } else {
      fields.forEach(f => {
        if(omitL1L3El?.checked && ['1','2','3'].includes(f.dataset.line)) return;
        let v = f.value;
        if(f.dataset.line === '6') v = formatLine6(f.value);
        if(f.dataset.line === '2') v = formatHeading(f.value);
        if(f.dataset.line === '3') v = formatDistance(f.value);
        if(f.dataset.line === '8') v = control === 'Tipo 3' ? `${t('cas.allies')} ${f.value}` : formatDirectionOrText(f.value, t('cas.allies'));
        if(f.dataset.line === '9') v = control === 'Tipo 3' ? `${t('cas.egress')} ${f.value}` : formatDirection(f.value, t('cas.egress'));
        out += `- ${v}<br>`;
      });
    }
    if(omitL1L3El?.checked){
      out += `- ${t('cas.lines_1_3_overhead')}<br>`;
    }
    if(includeRemarksEl?.checked && (remarks || formatVectorFinal() || preauthToggleEl?.checked || alliesInAreaToggleEl?.checked || formatDangerClose() || (killboxToggleEl?.checked && (killboxInputEl?.value || '').trim()))){
      const vec = formatVectorFinal();
      const danger = formatDangerClose();
      out += `<br><b>${t('cas.remarks_label')}</b><br>`;
      const kbName = (killboxInputEl?.value || '').trim();
      if(preauthToggleEl?.checked){
        out += `${t('cas.preauth')}${(killboxToggleEl?.checked && kbName) ? ` ${t('cas.in')} <span class="danger">${t('cas.killbox')} ${kbName}</span>` : ''}<br>`;
      } else if(killboxToggleEl?.checked && kbName){
        out += `<span class="danger">${t('cas.killbox')} ${kbName}</span><br>`;
      }
      if(alliesInAreaToggleEl?.checked) out += `<span class="ally-text">${t('cas.allies_in_area')}</span><br>`;
      if(danger) out += `${danger}<br>`;
      if(vec) out += `${vec}<br>`;
      if(remarks) out += `${remarks}<br>`;
    }
  }

  out = out.replace(/\&deg;/g, '\&deg;').replace(/\&plusmn;/g, '\&plusmn;');
  out = colorizeCallsigns(out, jtac, activeAir.l1 || '');
  casOutput.innerHTML = out;
  saveState();
}

// ====== Reset global ======
function clearAll(){
  suppressSave = true;
  airStore = [{},{},{}];
  currentAir = 0;
  airPresent = [false,false,false];
  airPresentEls.forEach(el=>{ if(el) el.checked = false; });
  missionStore = [null,null,null];
  missionPresent = [false,false,false];
  currentMission = 0;
  missionPresentEls.forEach(el=>{ if(el) el.checked = false; });
  csJtac.value = '';
  if(csGround) csGround.value = '';
  linerSelect.value = '9';
  updateLiner();
  [airL1,airL2,airL3,airL4,airL5,airL6,airL7].forEach(i=>{ if(i) i.value=''; });
  castypeEls.forEach(i=> i.checked=false);
  attackMethodEls.forEach(i=> i.checked=false);
  setSelectedMunitionList([]);
  casRemarksEl.value = '';
  if(includeRemarksEl) includeRemarksEl.checked = false;
  if(preauthToggleEl) preauthToggleEl.checked = false;
  if(alliesInAreaToggleEl) alliesInAreaToggleEl.checked = false;
  updateAlliesInAreaColor();
  if(killboxToggleEl) killboxToggleEl.checked = false;
  if(killboxInputEl) killboxInputEl.value = '';
  if(dangerCloseToggleEl) dangerCloseToggleEl.checked = false;
  if(dangerCloseDegEl) dangerCloseDegEl.value = '';
  if(dangerCloseDistEl) dangerCloseDistEl.value = '';
  if(vectorFinalToggleEl) vectorFinalToggleEl.checked = false;
  if(vectorFinalDegEl) vectorFinalDegEl.value = '';
  if(vectorFinalVarEl) vectorFinalVarEl.value = '';
  updateRemarksVisibility();
  updateVectorFinalVisibility();
  updateDangerCloseVisibility();
  updatePreauthVisibility();
  saveState();
  [...linerFields.querySelectorAll('input[data-line]')].forEach(i=> i.value='');
  casOutput.innerHTML = '';
  suppressSave = false;
}

</script>

</body>
</html>




